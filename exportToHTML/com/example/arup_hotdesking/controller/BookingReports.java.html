<html>
<head>
<title>BookingReports.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #000080; font-weight: bold;}
.s1 { color: #000000;}
.s2 { color: #008000; font-weight: bold;}
.s3 { color: #0000ff;}
</style>
</head>
<body bgcolor="#ffffff">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#c0c0c0" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
BookingReports.java</font>
</center></td></tr></table>
<pre><span class="s0">package </span>com.example.arup_hotdesking.controller;

<span class="s0">import </span>androidx.annotation.NonNull;
<span class="s0">import </span>androidx.appcompat.app.AppCompatActivity;
<span class="s0">import </span>androidx.core.content.FileProvider;

<span class="s0">import </span>android.content.Context;
<span class="s0">import </span>android.content.Intent;
<span class="s0">import </span>android.net.Uri;
<span class="s0">import </span>android.os.Bundle;
<span class="s0">import </span>android.view.View;
<span class="s0">import </span>android.widget.Button;
<span class="s0">import </span>android.widget.ListView;
<span class="s0">import </span>android.widget.Toast;

<span class="s0">import </span>com.example.arup_hotdesking.R;
<span class="s0">import </span>com.example.arup_hotdesking.model.BookinListAdapter;
<span class="s0">import </span>com.example.arup_hotdesking.model.BookinRecords;
<span class="s0">import </span>com.example.arup_hotdesking.model.BookingDateRange;
<span class="s0">import </span>com.google.android.gms.tasks.OnCompleteListener;
<span class="s0">import </span>com.google.android.gms.tasks.Task;
<span class="s0">import </span>com.google.firebase.auth.FirebaseAuth;
<span class="s0">import </span>com.google.firebase.firestore.DocumentSnapshot;
<span class="s0">import </span>com.google.firebase.firestore.FirebaseFirestore;
<span class="s0">import </span>com.google.firebase.firestore.QueryDocumentSnapshot;
<span class="s0">import </span>com.google.firebase.firestore.QuerySnapshot;

<span class="s0">import </span>java.io.File;
<span class="s0">import </span>java.io.FileNotFoundException;
<span class="s0">import </span>java.io.FileOutputStream;
<span class="s0">import </span>java.io.IOException;
<span class="s0">import </span>java.text.ParseException;
<span class="s0">import </span>java.text.SimpleDateFormat;
<span class="s0">import </span>java.util.ArrayList;
<span class="s0">import </span>java.util.Calendar;
<span class="s0">import </span>java.util.Date;

<span class="s0">public class </span>BookingReports <span class="s0">extends </span>AppCompatActivity {

    <span class="s0">private </span>FirebaseFirestore firebaseFirestore;
    <span class="s0">private </span>FirebaseAuth firebaseAuth;
    <span class="s0">private </span>Button export;
    <span class="s0">private </span>ListView listViewB;
    <span class="s0">private </span>ArrayList&lt;String&gt; id = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;String&gt; email = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;String&gt; desktitle = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;String&gt; newemail = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;String&gt; newdesktitle = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;String&gt; newbookingRange = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>ArrayList&lt;BookinRecords&gt; complete = <span class="s0">new </span>ArrayList&lt;&gt;();
    <span class="s0">private </span>SimpleDateFormat dateFormat = <span class="s0">new </span>SimpleDateFormat(<span class="s2">&quot;d/M/yyyy&quot;</span>);

    @Override
    <span class="s0">protected void </span>onCreate(Bundle savedInstanceState) {
        <span class="s0">super</span>.onCreate(savedInstanceState);
        setContentView(R.layout.activity_booking_reports);

        firebaseAuth = FirebaseAuth.getInstance();
        firebaseFirestore = FirebaseFirestore.getInstance();
        export = findViewById(R.id.btn_booking_export);
        listViewB = findViewById(R.id.listview_booking);

        firebaseFirestore.collection(<span class="s2">&quot;BookingRecords&quot;</span>).get().addOnCompleteListener(<span class="s0">new </span>OnCompleteListener&lt;QuerySnapshot&gt;() {
            @Override
            <span class="s0">public void </span>onComplete(@NonNull Task&lt;QuerySnapshot&gt; task) {

                <span class="s0">if </span>(task.isSuccessful()) {
                    <span class="s0">for </span>(QueryDocumentSnapshot document : task.getResult()) {
                        id.add(document.getId());
                        desktitle.add(document.getString(<span class="s2">&quot;deskTitle&quot;</span>));
                        email.add(document.getString(<span class="s2">&quot;email&quot;</span>));

                    }
                    <span class="s0">for </span>(<span class="s0">int </span>i = <span class="s3">0</span>; i &lt; id.size(); i++) {
                        firebaseFirestore.collection(<span class="s2">&quot;BookingRecords&quot;</span>).document(id.get(i).toString()).get().addOnCompleteListener(<span class="s0">new </span>OnCompleteListener&lt;DocumentSnapshot&gt;() {
                            @Override
                            <span class="s0">public void </span>onComplete(@NonNull Task&lt;DocumentSnapshot&gt; task) {
                                <span class="s0">final </span>String floorSelected= BookingDateRange.getFloor();
                                String currDeskTitle, currEmail;

                                DocumentSnapshot document = task.getResult();
                                ArrayList&lt;String&gt; currBooking;

                                currBooking = (ArrayList&lt;String&gt;) document.get(<span class="s2">&quot;bookingRange&quot;</span>);
                                currEmail = document.getString(<span class="s2">&quot;email&quot;</span>);
                                currDeskTitle = document.getString(<span class="s2">&quot;deskTitle&quot;</span>);
                                <span class="s0">if</span>(currDeskTitle.startsWith(floorSelected)){
                                    add(currEmail, currDeskTitle, currBooking);
                                }

                            }
                        });

                    }

                } <span class="s0">else </span>{
                    Toast.makeText(BookingReports.<span class="s0">this</span>, <span class="s2">&quot;Error: &quot; </span>+ task.getException(), Toast.LENGTH_SHORT).show();

                }
                export.setOnClickListener(<span class="s0">new </span>View.OnClickListener() {
                    @Override
                    <span class="s0">public void </span>onClick(View view) {

                        String currEmail = firebaseAuth.getCurrentUser().getEmail().toString();
                        StringBuilder data = <span class="s0">new </span>StringBuilder();
                        data.append(<span class="s2">&quot;User,Desk,Booking Details&quot;</span>);

                        <span class="s0">for </span>(<span class="s0">int </span>i = <span class="s3">0</span>; i &lt; newemail.size(); i++) {
                            data.append(<span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot; </span>+ newemail.get(i).toString() + <span class="s2">&quot;,&quot; </span>+ newdesktitle.get(i).toString() + <span class="s2">&quot;,&quot; </span>+ newbookingRange.get(i).toString());
                        }

                        <span class="s0">try </span>{

                            FileOutputStream out = openFileOutput(<span class="s2">&quot;BookingReport.csv&quot;</span>, Context.MODE_PRIVATE);
                            out.write(data.toString().getBytes());
                            out.close();

                            Context context = getApplicationContext();
                            File fileLocation = <span class="s0">new </span>File(getFilesDir(), <span class="s2">&quot;BookingReport.csv&quot;</span>);
                            Uri path = FileProvider.getUriForFile(context, <span class="s2">&quot;com.example.exportcsv.fileprovider&quot;</span>, fileLocation);

                            Intent fileIntent = <span class="s0">new </span>Intent(Intent.ACTION_SEND);
                            fileIntent.setType(<span class="s2">&quot;text/csv&quot;</span>);

                            fileIntent.putExtra(Intent.EXTRA_EMAIL, <span class="s0">new </span>String[]{currEmail});
                            fileIntent.putExtra(Intent.EXTRA_SUBJECT, <span class="s2">&quot;Booking Reservation Report&quot;</span>);
                            fileIntent.putExtra(Intent.EXTRA_TEXT, <span class="s2">&quot;Hi, &quot; </span>+ <span class="s2">&quot;</span><span class="s0">\n\n</span><span class="s2">&quot; </span>+ <span class="s2">&quot;Attached is the booking reservation reports.&quot; </span>+ <span class="s2">&quot;</span><span class="s0">\n\n</span><span class="s2">&quot; </span>+ <span class="s2">&quot;Regards,&quot; </span>+ <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>);
                            fileIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);

                            fileIntent.putExtra(Intent.EXTRA_STREAM, path);
                            startActivity(Intent.createChooser(fileIntent, <span class="s2">&quot;Send mail&quot;</span>));


                        } <span class="s0">catch </span>(FileNotFoundException e) {
                            e.printStackTrace();
                        } <span class="s0">catch </span>(IOException e) {
                            e.printStackTrace();
                        }

                    }
                });
            }
        });

    }
            <span class="s0">public void </span>add(String emailB, String deskname, ArrayList collect) {

                <span class="s0">final </span>String toCalendar = BookingDateRange.getBookingTo();
                <span class="s0">final </span>String fromCalendar = BookingDateRange.getBookingFrom();

                String[] CESplit;
                String day, month, year;


                <span class="s0">for </span>(<span class="s0">int </span>z = <span class="s3">0</span>; z &lt; collect.size(); z++) {
                    String newMonth, finMonth, finDay;
                    CESplit = collect.get(z).toString().split(<span class="s2">&quot;,&quot;</span>);
                    year = CESplit[<span class="s3">3</span>].substring(<span class="s3">6</span>, <span class="s3">10</span>);
                    month = CESplit[<span class="s3">10</span>];
                    day = CESplit[<span class="s3">35</span>];

                    <span class="s0">if </span>(month.contains(<span class="s2">&quot;tD&quot;</span>)) {
                        newMonth = CESplit[<span class="s3">11</span>];
                    } <span class="s0">else </span>{
                        newMonth = CESplit[<span class="s3">10</span>];
                    }

                    <span class="s0">if </span>(newMonth.length() == <span class="s3">8</span>) {
                        finMonth = newMonth.substring(<span class="s3">7</span>, <span class="s3">8</span>);
                    } <span class="s0">else </span>{
                        finMonth = newMonth.substring(<span class="s3">7</span>, <span class="s3">9</span>);
                    }

                    <span class="s0">if </span>(day.length() == <span class="s3">7</span>) {
                        finDay = day.substring(<span class="s3">5</span>, <span class="s3">7</span>);
                    } <span class="s0">else </span>finDay = day.substring(<span class="s3">5</span>, <span class="s3">6</span>);

                    String date = finDay + <span class="s2">&quot;/&quot; </span>+ finMonth + <span class="s2">&quot;/&quot; </span>+ year;
                    Date dateObj = <span class="s0">null</span>;
                    Date fromObj = <span class="s0">null</span>;
                    Date toObj = <span class="s0">null</span>;
                    <span class="s0">try </span>{
                        dateObj = dateFormat.parse(date);
                        fromObj = dateFormat.parse(fromCalendar);
                        toObj = dateFormat.parse(toCalendar);
                    } <span class="s0">catch </span>(ParseException e) {
                        e.printStackTrace();
                    }
                    Calendar cal = Calendar.getInstance();
                    Calendar fromCal = Calendar.getInstance();
                    Calendar toCal = Calendar.getInstance();
                    cal.setTime(dateObj);
                    fromCal.setTime(fromObj);
                    toCal.setTime(toObj);

                    fromCal.add(Calendar.DAY_OF_MONTH, -<span class="s3">1</span>);
                    toCal.add(Calendar.DAY_OF_MONTH, <span class="s3">1</span>);

                    <span class="s0">if </span>(cal.before(toCal) &amp;&amp; cal.after(fromCal)) {

                        newemail.add(emailB);
                        newdesktitle.add(deskname);
                        newbookingRange.add(date);
                        BookinRecords record = <span class="s0">new </span>BookinRecords(emailB, deskname, date);
                        complete.add(record);

                        BookinListAdapter adapter = <span class="s0">new </span>BookinListAdapter(<span class="s0">this</span>, R.layout.bookin_item, complete);
                        listViewB.setAdapter(adapter);

                    }

                }

            }

        }
</pre>
</body>
</html>